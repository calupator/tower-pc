TECH
NOTEBOOK

A forum for sharing solutions
to technikal problems

PC TECH JOURNAL, NOVEMBER 1988


Doubling effectiv VGA resolution

Стандартные VGA в графических режимах поддерживают максимальное
разрешение 640х480 пиксел. Когда изображаются символы, пикселы могут
быть собраны в символ различными способами, дающими различное число
строк и столбцов, в зависимости от числа пиксел на символ. Используя
стандартные фонты в ROM VGA, на графическом экране можно изобразить
либо 80 столбцов на 30 строк (используя матрицу 8х16 пиксел), либо
80 столбцов на 60 строк (используя матрицу 8х8 пиксел). Другие
комбинации могут быть получены программным управлением
видеорегистров, обеспечивающим доступ к фонту с требуемым размером
символов.

Например, фонт с шириной символа в 4 пиксела позволяет изображать
160 символов на каждой линии. Однако, такие символы трудночитаемы.
При обычных обстоятельствах пользователи отдают предпочтение более
длинному фонту, который хоть и представляет меньше информации на
линии, зато выглядит лучше. При возможности, однако, они используют
при выводе zoom, чтобы видеть на экране гораздо больше информации.

Многие EGA и VGA адаптеры включают видеодрайверы, которые
устанавливают текстовые режимы двойной плотности для различных
приложений. Переключение в и из таких режимов, однако, обычно
требует выхода и затем перезапуска приложения. В идеале переключение
экранных режимов должно быть возможным из приложений; оно должно
быть мгновенным и не должно вызывать перерисовку всего экрана.
Особенности hardware VGA позволяют программистам выполнять такие
действия.

Программа VGAZOOM (часть которой приводится в листинге 1) переводит
VGA в режим высокого разрешения (для текстов 160 столбцов на 60
строк). При нажатии клавиши дисплей переключается в режим низкого
разрешения (80 столбцов на 60 строк), сохраняющий содержимое
видеобуфера и продолжающий вывод изображения в левую половину
экрана. Пользователь может затем сделать перемотку влево и вправо
для вывода любой части 160 столбцов, или нажать выделенную клавишу
для переустановки режима высокого разрешения.

В противовес плохочитаемому четырех-битовому фонту, 160-столбцовый
режим выполнен формированием VGA подобно монохромной битовой карте
из 1280х480 пиксел. Кроме того, в этой битовой карте текст выполнен
с использованием фонта VGA 8х8 пиксел. Хотя описывалось текстовое
приложение, в действительности hardware находится в графическом
режиме. Подобный технический прием может быть использован и для
вывода графики в режиме почти двойного, по сравнению со стандартом
VGA, разрешения.

Режим высокого разрешения, получаемый программированием VGA,
изображает один пиксел на экране для каждых двух пиксел в
видеопамяти. Таким образом, линия сканирования с 640 пикселами вдоль
экрана содержит в себе информацию из 1280 пиксел в видеопамяти. При
комбинировании пиксел таким образом, однако, теряется информация;
четыре возможных значения для пары пиксел уменьшаются до двух в
одном пикселе.

Потеря информации приводит к искажению, известному как alias (alias
- вымышленное имя), в изображаемой картинке. Характеристики монитора
VGA, однако, позволяют применять против этого метод восстановления
некоторой потерянной информации с помощью улучшения вида
четырех-битового фонта.

Антиалиасинговые приемы, в которых пространственное разрешение
компенсируется цветовым, широко используется в комерческом
телевидении. Телевидение имеет очень низкое пространственное
разрешение, но может изображать произвольное неограниченное число
цветов и оттенков. Много цветовых компенсаций для нескольких пиксел,
в результате, придают изображению весьма удовлетворительный вид. В
большинстве случаев качество изображения на стандартном
телевизионном экране кажется выше, чем на компьютерном мониторе с
высоким разрешением.

Поскольку эти устройства аналогичны, монитор VGA так же может
изображать большое количество оттенков.
Этот один пиксел должен быть не только засвечен или не засвечен, но
должен изображаться с рядом оттенков. Пиксе в четырех-битовом фонте
изображается одним из трех оттенков серого в зависимости от
составляющих его пиксел : оба установлены, оба сброшены или один
установлен и один сброшен. В графическом режиме четвертый оттенок
может быть получен разделением случаев : установлен-сброшен и
сброшен-установлен, но это не принесет пользы при изображении
текста.

Этот технический прием проиллюстрирован на рис. 1. Показанное может
быть улучшено разработкой девятибитового фонта специально для сжатия
и антиалиаса, но даже стандартный фонт дает приемлемые результаты.

Выполнение VGAZOOM требует перепрограммирования четырех основных
характеристик VGA. Подробное об'яснение, как программировать VGA на
уровне регистров, не приводится здесь, но предполагается, что вы
знакомы с архитектурой VGA по IBM PS/2 Hardware Interface -
Technical Reference.

Сначало рассмотрим распределение дисплейной памяти в адресном
пространстве CPU. В 16-цветных графических режимах под каждый байт,
записанный CPU в видеобуфер, hardware VGA расходует четыре байта,
один байт в каждом из четырех битовых plane. В монохромных режимах,
которые используются в VGAZOOM, каждый байт дисплейной памяти
отображается на один байт в адресном пространстве CPU так, что
каждый бит в памяти представляет один пиксел. Распределение
видеопамяти управляется содержимым memory-mode регистра (смещение 4
в sequencer register set).

Далее устанавливаются via (через) и shift (сдвиг) регистры.
Изображая содержимое видеобуфера, hardware загружает 32-битовое
слово из буфера в shift регистры. При каждом цикле dot clock (dot -
точка, clock - часы) один, два или четыре бита перемещаются из
регистров в dot генератор, создающий один пиксел на экране.

На рис. 2 показаны три различных VGA режима. В 16-цветовом режиме
регистры запрограммированы посылать четыре бита за цикл. Содержимое
перемещается из регистров, и они должны быть перезагружены для
каждого девятого цикла dot часов (один цикл символьных часов
(character clock)).

В монохромном режиме 32 бита в shift регистрах представляют 32
пиксела. При генерации 640 dot на линию сканирования shift регистры
сдвигаются цепочкой, выводя один бит за dot цикл, освобождая
регистры за 32 цикла. Для вывода 1280 dot на линию сканирования
shift регистры программируются выводить два бита за dot цикл. Два
бита представляют два пиксела в видеопамяти, но производят один
пиксел на экране, в результате фонт сжимается 2:1, как было описано
ранее. В этом случае shift регистры должны быть перезагружены через
каждые 16 dot циклов.

Для программирования shift регистров требуется сделать запись в три
VGA регистра. Graphics-mode регистр (смещение 5 в
graphics-controller register set) определяет цепочку регистров в 1,
2 или 4 параллельных устройствах. Color-plane-enable регистр
(смещение 12H в attribute controller registr set) определяет как
много бит надо послать в dot генератор за каждый цикл. Наконец
clocking-mode регистр (смещение 1 в sequenser registr set)
определяет частоту перезагрузки shift регистров - каждые 8, 16 или
32 dot цикла.

Третьим вопросом для обсуждения будет установка серой шкалы, которая
выполняет антиалиас. Окончательный цвет пиксела определяется в
digital-to-analog converter (DAC), который производит аналоговый
сигнал для дисплея. DAC содержит 256 цветовых регистра, каждый
шириной 18 бит, позволяющих изображать 256 цветов одновременно из
палитры в 262144 цвета. Когда dot генератор создает пиксел, то
значения бит пиксела и определяют один из этих регистров цвета,
содержащий значения уровней красного, зеленого и синего
видеосигналов, которые DAC посылает в дисплей. В 1280-пиксельном
режиме два бита, определяющие каждый экранный пиксел, могут выбрать
один из первых четырех color регистров. Они загружены со значением
черный, серый, серый и белый соответственно для значений бит: оба
off; один off, один on и оба on.

Листинг 1, VGAZOOM.ASM, показывает основные процедуры, которые
устанавливают и используют 1280-пиксельный графический режим.

SetMode инициализирует VGA в 1280- и 640-пиксельный режим, записывая
соответствующие значения во все регистры VGA. Две таблицы,
определенные в процедуре, содержат параметры для каждого режима.
Коментарии раскрывают их основное содержание.

W_Palette устанавливает внешнюю палитру в DAC. Ввод процедуры
использует I/O адресс для address регистра, число записанных pallet
регистров и указатель в памяти таблицы значений цветов. Загрузка
color регистров включает в себя четыре шага : запись индекса
отмеченного регистра в address регистр и, затем, запись трех байт
красного, зеленого и синего цветов (в этом порядке) в следующий
последовательный I/O address. Hardware об'единяет
шесть младших бит каждого байта в значение 18-битовой палитры и,
затем, автоматически увеличивает индекс в address регистре.

Другая процедура Drawchr рисует символ на экране. Ввод процедуры
использует адресс в дисплейной памяти принимаемого символа, базовый
адресс фонта и высоту символа в scan линиях. Процедура принимает
фиксированный фонт шириной в 8 пиксел.

Vert_Scroll перематывает изображение вверх или вниз. Вход использует
ширину фонта и число линий перемотки вверх (отрицательное число
вызывает перемотку вниз).

Процедура Horiz_Scroll_4 перематывает изображение влево или вправо в
640-пиксельном режиме, используя для этого возможности,
предоставляемые hardware VGA. Вход использует ширину бит-карты и
число пиксел для перемотки вправо (отрицательное число - перемотка
влево). Rd_IndexReg, W_Index_Regs, W_Attr_Regs - вспомогательные
процедуры, которые облегчают задачу чтения из и записи в различные
регистры VGA.

Процедуры в листинге не могут быть выполнены в том виде, в каком
напечатаны, потому, что отсутствует головная программа.

